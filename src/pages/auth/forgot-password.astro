---
import Layout from '@/layouts/PageLayout.astro';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Loader2 } from 'lucide-react';

const metadata = {
  title: 'Recuperar Contraseña - Simplex',
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  <div class="min-h-screen flex items-center justify-center px-4 py-8">
    <Card className="w-full max-w-sm">
      <form id="recovery-form" method="POST" action="/api/auth/forgot-password">
        <CardHeader>
          <CardTitle>Recuperar contraseña</CardTitle>
          <CardDescription>
            Ingresa tu correo electrónico
          </CardDescription>
        </CardHeader>

        <CardContent className="space-y-4">
          <div id="error-alert" class="hidden">
            <Alert variant="destructive">
              <AlertDescription id="error-message" />
            </Alert>
          </div>

          <div id="success-alert" class="hidden">
            <Alert variant="default">
              <AlertDescription id="success-message" />
            </Alert>
          </div>

          <div class="space-y-2">
            <Label htmlFor="email">Correo electrónico</Label>
            <Input
              id="email"
              type="email"
              name="email"
              placeholder="tunombre@correo.com"
              autoComplete="email"
              data-validate="email"
            />
            <p id="email-error" class="text-sm text-destructive hidden"></p>
          </div>
        </CardContent>

        <CardFooter className="flex-col gap-4">
          <Button type="submit" className="w-full" id="submit-button">
            <span id="button-text" class="text-white">Enviar enlace</span>
            <span id="button-loader" class="hidden">
              <span class="inline-flex items-center">
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Enviando...
              </span>
            </span>
          </Button>

          <p class="text-sm text-center text-muted-foreground">
            <a href="/auth/login" class="text-primary underline-offset-4 hover:underline">
              Volver al inicio de sesión
            </a>
          </p>
        </CardFooter>
      </form>
    </Card>
  </div>
</Layout>

<script>
  // Esquema de validación
  const recoverySchema = {
    email: (val: string) => {
      if (!val) return 'El correo es requerido';
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)) return 'Formato de correo inválido';
      return null;
    },
  };

  const form = document.getElementById('recovery-form') as HTMLFormElement | null;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement | null;
  const errorAlert = document.getElementById('error-alert') as HTMLElement | null;
  const errorMessage = document.getElementById('error-message') as HTMLElement | null;
  const successAlert = document.getElementById('success-alert') as HTMLElement | null;
  const successMessage = document.getElementById('success-message') as HTMLElement | null;

  let isSubmitting = false;

  if (!form || !submitButton) throw new Error('Elementos del DOM no encontrados');

  function showFieldError(fieldId: string, message: string) {
    const errorElement = document.getElementById(`${fieldId}-error`);
    const input = document.getElementById(fieldId);
    if (errorElement && input) {
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
      input.classList.add('border-destructive');
    }
  }

  function clearFieldError(fieldId: string) {
    const errorElement = document.getElementById(`${fieldId}-error`);
    const input = document.getElementById(fieldId);
    if (errorElement && input) {
      errorElement.classList.add('hidden');
      input.classList.remove('border-destructive');
    }
  }

  function validateField(fieldName: 'email', value: string) {
    const validator = recoverySchema[fieldName];
    const error = validator(value);
    if (error) {
      showFieldError(fieldName, error);
      return false;
    }
    clearFieldError(fieldName);
    return true;
  }

  // Listeners de validación en tiempo real
  const emailInput = document.getElementById('email') as HTMLInputElement | null;
  if (emailInput) {
    emailInput.addEventListener('blur', () => {
      validateField('email', emailInput.value);
    });

    emailInput.addEventListener('input', () => {
      clearFieldError('email');
      errorAlert?.classList.add('hidden');
      successAlert?.classList.add('hidden');
    });
  }

  // Manejador del envío
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isSubmitting) return;

    const formData = new FormData(form);
    const email = (formData.get('email') as string || '').trim();

    if (!validateField('email', email)) return;

    isSubmitting = true;
    submitButton.disabled = true;
    document.getElementById('button-text')?.classList.add('hidden');
    document.getElementById('button-loader')?.classList.remove('hidden');

    try {
      const params = new URLSearchParams();
      params.append('email', email);

      const response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json'
        },
        body: params,
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(data.error || 'Error al enviar el enlace de recuperación');
      }

      // Mostrar mensaje de éxito
      if (successMessage && successAlert) {
        successMessage.textContent = 'Se ha enviado un enlace de recuperación a tu correo.';
        successAlert.classList.remove('hidden');
        errorAlert?.classList.add('hidden');
        form.reset();
      }

    } catch (err: unknown) {
      if (errorMessage && errorAlert) {
        const message = err instanceof Error ? err.message : 'Ocurrió un error inesperado';
        errorMessage.textContent = message;
        errorAlert.classList.remove('hidden');
        successAlert?.classList.add('hidden');
      }
    } finally {
      isSubmitting = false;
      submitButton.disabled = false;
      document.getElementById('button-text')?.classList.remove('hidden');
      document.getElementById('button-loader')?.classList.add('hidden');
    }
  });
</script>