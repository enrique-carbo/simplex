---
import Layout from '@/layouts/PageLayout.astro';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Loader2, CheckCircle } from 'lucide-react';

const metadata = {
  title: 'Restablecer Contraseña - Simplex',
  ignoreTitleTemplate: true,
};

// CORRECCIÓN: Usar .get() para obtener parámetros de URL
const url = Astro.url;
const token = url.searchParams.get('token');
const hasValidParams = Boolean(token);
---

<Layout metadata={metadata}>
  <div class="min-h-screen flex items-center justify-center px-4 py-8">
    <Card className="w-full max-w-sm">
      {!hasValidParams ? (
        <>
          <CardHeader>
            <CardTitle className="text-destructive">Enlace inválido</CardTitle>
            <CardDescription>
              Este enlace de restablecimiento es incorrecto o ha expirado.
            </CardDescription>
          </CardHeader>
          <CardFooter>
            <a href="/forgot-password" class="w-full">
              <Button variant="outline" className="w-full">
                Solicitar nuevo enlace
              </Button>
            </a>
          </CardFooter>
        </>
      ) : (
        <form id="reset-form">
          <input type="hidden" name="token" value={token!}/>
          
          <CardHeader>
            <CardTitle>Nueva contraseña</CardTitle>
            <CardDescription>
              Crea una nueva contraseña para tu cuenta.
            </CardDescription>
          </CardHeader>

          <CardContent className="space-y-4">
            <!-- Alertas -->
            <div id="error-alert" class="hidden">
              <Alert variant="destructive">
                <AlertDescription id="error-message" />
              </Alert>
            </div>

            <div id="success-alert" class="hidden">
              <Alert variant="default" className="bg-green-50 border-green-200 text-green-800">
                <CheckCircle className="h-4 w-4 mr-2" />
                <AlertDescription id="success-message" />
              </Alert>
            </div>

            <!-- Campo de contraseña -->
            <div class="space-y-2">
              <Label htmlFor="password">Nueva contraseña</Label>
              <Input
                id="password"
                type="password"
                name="password"
                placeholder="Mínimo 8 caracteres"
                autoComplete="new-password"
                data-validate="password"
              />
              <p id="password-error" class="text-sm text-destructive hidden"></p>
              <p class="text-xs text-muted-foreground">
                La contraseña debe tener al menos 8 caracteres.
              </p>
            </div>

            <!-- Confirmar contraseña -->
            <div class="space-y-2">
              <Label htmlFor="passwordConfirm">Confirmar contraseña</Label>
              <Input
                id="passwordConfirm"
                type="password"
                name="passwordConfirm"
                placeholder="Repite la contraseña"
                autoComplete="new-password"
                data-validate="passwordConfirm"
              />
              <p id="passwordConfirm-error" class="text-sm text-destructive hidden"></p>
            </div>
          </CardContent>

          <CardFooter className="flex-col gap-4">
            <Button type="submit" className="w-full" id="submit-button">
              <span id="button-text">Restablecer contraseña</span>
              <span id="button-loader" class="hidden">
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Procesando...
              </span>
            </Button>

            <p class="text-sm text-center text-muted-foreground">
              <a href="/auth/login" class="text-primary underline-offset-4 hover:underline">
                ← Volver al inicio de sesión
              </a>
            </p>
          </CardFooter>
        </form>
      )}
    </Card>
  </div>
</Layout>

{hasValidParams && (
<script>
  // SIGUIENDO EL MISMO PATRÓN QUE register.astro
  type ValidField = 'password' | 'passwordConfirm';

  const resetSchema = {
    password: (val: string) => {
      if (!val) return 'La contraseña es requerida';
      if (val.length < 8) return 'Mínimo 8 caracteres';
      return null;
    },
    passwordConfirm: (val: string) => {
      const password = (document.getElementById('password') as HTMLInputElement).value;
      if (!val) return 'Confirme su contraseña';
      if (val !== password) return 'Las contraseñas no coinciden';
      return null;
    }
  };

  const form = document.getElementById('reset-form') as HTMLFormElement | null;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement | null;
  const errorAlert = document.getElementById('error-alert') as HTMLElement | null;
  const errorMessage = document.getElementById('error-message') as HTMLElement | null;
  const successAlert = document.getElementById('success-alert') as HTMLElement | null;
  const successMessage = document.getElementById('success-message') as HTMLElement | null;

  let isSubmitting = false;

  if (!form || !submitButton) throw new Error('Elementos del DOM no encontrados');

  function showFieldError(fieldId: string, message: string) {
    const errorElement = document.getElementById(`${fieldId}-error`);
    const input = document.getElementById(fieldId);
    if (errorElement && input) {
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
      input.classList.add('border-destructive');
    }
  }

  function clearFieldError(fieldId: string) {
    const errorElement = document.getElementById(`${fieldId}-error`);
    const input = document.getElementById(fieldId);
    if (errorElement && input) {
      errorElement.classList.add('hidden');
      input.classList.remove('border-destructive');
    }
  }

  function validateField(fieldName: ValidField, value: string) {
    const validator = resetSchema[fieldName];
    const error = validator(value);
    if (error) {
      showFieldError(fieldName, error);
      return false;
    }
    clearFieldError(fieldName);
    return true;
  }

  // Validación en tiempo real (mismo patrón que register.astro)
  form.querySelectorAll<HTMLInputElement>('[data-validate]').forEach(input => {
    input.addEventListener('blur', (e) => {
      const target = e.target as HTMLInputElement;
      const fieldName = target.dataset.validate;
      
      // Validamos que el nombre del campo sea uno de los esperados
      if (fieldName === 'password' || fieldName === 'passwordConfirm') {
        validateField(fieldName, target.value);
      }
    });

    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      clearFieldError(target.id);
      errorAlert?.classList.add('hidden');
      successAlert?.classList.add('hidden');
    });
  });

  // Manejador del envío (mismo patrón que register.astro)
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isSubmitting) return;

    const formData = new FormData(form);
    const password = formData.get('password') as string || '';
    const passwordConfirm = formData.get('passwordConfirm') as string || '';
    const token = formData.get('token') as string || '';
    const userId = formData.get('userId') as string || '';

    if (!validateField('password', password) || !validateField('passwordConfirm', passwordConfirm)) return;

    isSubmitting = true;
    submitButton.disabled = true;
    document.getElementById('button-text')?.classList.add('hidden');
    document.getElementById('button-loader')?.classList.remove('hidden');

    try {
      const params = new URLSearchParams();
      params.append('token', token);
      params.append('userId', userId);
      params.append('password', password);
      params.append('passwordConfirm', passwordConfirm);

      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json'
        },
        body: params,
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(data.error || 'Error al restablecer la contraseña');
      }

      // Éxito - mismo patrón que register.astro pero con mensaje de éxito
      if (successMessage && successAlert) {
        successMessage.textContent = data.message || '¡Contraseña restablecida! Redirigiendo...';
        successAlert.classList.remove('hidden');
        errorAlert?.classList.add('hidden');

        // Redirigir después de 3 segundos
        setTimeout(() => {
          window.location.href = '/auth/login?reset=success';
        }, 3000);
      }

    } catch (err: unknown) {
      if (errorMessage && errorAlert) {
        errorMessage.textContent = err instanceof Error ? err.message : 'Error desconocido';
        errorAlert.classList.remove('hidden');
        successAlert?.classList.add('hidden');
      }
    } finally {
      // Desbloquear UI
      isSubmitting = false;
      submitButton.disabled = false;
      document.getElementById('button-text')?.classList.remove('hidden');
      document.getElementById('button-loader')?.classList.add('hidden');
    }
  });
</script>
)}