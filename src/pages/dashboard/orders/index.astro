---
import Layout from '@/layouts/PageLayout.astro';
import { Button } from '@/components/ui/button';
import { Package } from 'lucide-react';
import type { Order } from '@/types/order';

const metadata = {
  title: 'Mis Pedidos - Simplex',
  ignoreTitleTemplate: true,
};

const pb = Astro.locals.pb;
const { user, isLoggedIn } = Astro.locals;

if (!isLoggedIn) {
  return Astro.redirect('/auth/login');
}

// Obtener parÃ¡metros de paginaciÃ³n
const page = Number(Astro.url.searchParams.get('page')) || 1;
const perPage = 10;

// Obtener Ã³rdenes del usuario
let orders: Order[] = [];
let totalPages = 0;
let totalOrders = 0;

try {
  const result = await pb.collection('orders').getList<Order>(page, perPage, {
    filter: `user = "${user.id}"`,
    sort: '-created',
  });
  
  orders = result.items;
  totalPages = result.totalPages;
  totalOrders = result.totalItems;
} catch (error) {
  console.error('Error obteniendo Ã³rdenes:', error);
  orders = [];
}
---

<Layout metadata={metadata}>
  <div class="max-w-4xl mx-auto px-4 py-10">
    <div class="mb-8">
      <h1 class="text-3xl font-bold">Mis Pedidos</h1>
      <p class="text-muted-foreground mt-2">
        {totalOrders > 0 
          ? `Tienes ${totalOrders} pedido${totalOrders !== 1 ? 's' : ''} en total`
          : 'AÃºn no has realizado pedidos'}
      </p>
    </div>

    {orders.length > 0 ? (
      <div class="space-y-4">
        {orders.map((order) => {
          const statusConfig = {
            draft: { color: 'bg-gray-100 text-gray-800', text: 'Borrador' },
            pending: { color: 'bg-amber-100 text-amber-800', text: 'Pendiente' },
            processing: { color: 'bg-blue-100 text-blue-800', text: 'Procesando' },
            shipped: { color: 'bg-purple-100 text-purple-800', text: 'Enviado' },
            delivered: { color: 'bg-green-100 text-green-800', text: 'Entregado' },
            cancelled: { color: 'bg-red-100 text-red-800', text: 'Cancelado' }
          };
          
          const status = statusConfig[order.status] || { color: 'bg-gray-100 text-gray-800', text: order.status };
          const itemCount = Array.isArray(order.items) 
            ? order.items.reduce((sum: number, item: { quantity?: number }) => sum + (item.quantity || 1), 0)
            : 0;
          
          return (
            <a 
              href={`/dashboard/orders/${order.id}`}
              class="block border rounded-lg p-6 hover:bg-accent/50 transition-colors group"
            >
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="space-y-2">
                  <div class="flex items-center gap-3">
                    <h3 class="font-semibold">
                      Pedido #{order.id.substring(0, 8).toUpperCase()}
                    </h3>
                    <span class={`px-2 py-1 rounded-full text-xs font-medium ${status.color}`}>
                      {status.text}
                    </span>
                  </div>
                  <div class="flex flex-wrap gap-4 text-sm text-muted-foreground">
                    <span>
                      ðŸ“… {new Date(order.created).toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </span>
                    <span>ðŸ“¦ {itemCount} producto{itemCount !== 1 ? 's' : ''}</span>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-2xl font-bold">${order.total?.toFixed(2) || '0.00'}</p>
                  <p class="text-sm text-muted-foreground mt-1 group-hover:underline">
                    Ver detalles â†’
                  </p>
                </div>
              </div>
            </a>
          );
        })}

        {/* PaginaciÃ³n */}
        {totalPages > 1 && (
          <div class="flex justify-center items-center gap-2 pt-8">
            {page > 1 && (
              <a 
                href={`/dashboard/orders?page=${page - 1}`}
                class="px-4 py-2 border rounded hover:bg-accent"
              >
                Anterior
              </a>
            )}
            <span class="text-sm">
              PÃ¡gina {page} de {totalPages}
            </span>
            {page < totalPages && (
              <a 
                href={`/dashboard/orders?page=${page + 1}`}
                class="px-4 py-2 border rounded hover:bg-accent"
              >
                Siguiente
              </a>
            )}
          </div>
        )}
      </div>
    ) : (
      <div class="text-center py-16 border-2 border-dashed rounded-lg">
        <div class="mx-auto w-20 h-20 bg-muted rounded-full flex items-center justify-center mb-4">
          <Package className="h-10 w-10 text-muted-foreground" />
        </div>
        <h3 class="text-xl font-semibold mb-2">AÃºn no tienes pedidos</h3>
        <p class="text-muted-foreground mb-6 max-w-md mx-auto">
          Los pedidos que realices aparecerÃ¡n aquÃ­, con toda la informaciÃ³n sobre su estado y detalles.
        </p>
        <div class="flex gap-4 justify-center">
          <Button asChild>
            <a href="/productos">Explorar productos</a>
          </Button>
          <Button variant="outline" asChild>
            <a href="/dashboard">Volver al perfil</a>
          </Button>
        </div>
      </div>
    )}
  </div>
</Layout>